<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
>
<head>
<meta charset="UTF-8">
<title>Right</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<link rel="icon" href="/resources/favicon.ico">
<link rel="stylesheet" href="resources/layui/css/layui.css"
	th:href="@{/resources/layui/css/layui.css}" media="all" />
<link rel="stylesheet" th:href="@{/resources/css/public.css}"
	media="all" />
<link rel="stylesheet" th:href="@{/resources/layui_ext/dtree/dtree.css}"
	media="all" />
<link rel="stylesheet"
	th:href="@{/resources/layui_ext/dtree/font/dtreefont.css}" media="all" />
<style>
input#search_gateAuthorIdTree_select_input_id {
	border-radius: 10px;
	height: 30px;
	margin-top: 4px;
}

input#gateAuthorIdTree_select_input_id {
	border-radius: 10px;
	height: 30px;
	margin-top: 4px;
}

input#leadergateAuthorIdTree_select_input_id {
	border-radius: 10px;
	height: 30px;
	margin-top: 4px;
}

input.layui-input.layui-unselect {
	border-radius: 10px;
	height: 30px;
	margin-top: 4px;
}
</style>
</head>
<body>
	<!--查询条件-->
	<fieldset class="layui-elem-field layui-field-title"
		style="margin-top: 15px;">
		<legend th:text="#{searchParam}">搜索条件</legend>
	</fieldset>
	<form action="" method="post" id="searchFrm" lay-filter="searchFrm"
		class="layui-form">
		<div class="layui-form-item">
			<label class="layui-form-label" th:text="#{auth.gate_name}">选择闸机:</label>
			<div class="layui-input-inline">
				<select name="gateId" id="select_gateId">
					<option value=" " th:text="#{auth.gate_select}">请选择闸机:</option>
				</select>

			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-input-block"
				style="text-align: center; padding-right: 15%;">
				<button type="button"
					class="layui-btn layui-btn-sm layui-btn-radius" lay-submit=""
					lay-filter="doSearch">
					<i class="layui-icon layui-icon-search layui-icon-normal"></i><font th:text="#{doSearch}"></font>
				</button>
				<button type="reset"
					class="layui-btn layui-btn-sm layui-btn-radius layui-btn-warm">
					<i class="layui-icon layui-icon-refresh"></i><font th:text="#{reset}"></font>
				</button>
			</div>
		</div>
	</form>

	<!--数据表格-->
	<div>
		<table class="layui-hide" id="gateAuthorTable"
			lay-filter="gateAuthorTable"></table>
		<div id="gateAuthorToolBar" style="display: none">
			<button type="button" lay-event="add" class="layui-btn layui-btn-sm layui-btn-normal layui-btn-radius">
				<i class="layui-icon layui-icon-add-1"></i><font th:text="#{add_one}"></font>
			</button>
		</div>
		<div id="gateAuthorRowBar" style="display: none;">
			<button type="button" lay-event="update" class="layui-btn layui-btn-sm layui-btn-radius">
				<i class="layui-icon layui-icon-edit"></i><font th:text="#{form_edit}"></font>
			</button>
			<button type="button" lay-event="delete" class="layui-btn layui-btn-sm layui-btn-danger layui-btn-radius">
				<i class="layui-icon layui-icon-delete"></i><font th:text="#{delete}"></font>
			</button>
		</div>
	</div>

	<!--添加弹出层-->
	<div id="addGateAuthorDiv"
		style="display: none; padding: 10px; padding-right: 5%">
		<form action="" method="post" class="layui-form" id="dataFrm"
			lay-filter="dataFrm">
			<div class="layui-form-item">
				<label class="layui-form-label layui-required" th:text="#{auth.gate_name}">选择闸机:</label>
				<div class="layui-input-block">
					<select name="gateId" id="select_left_gateId">
						<option value=" " th:text="#{auth.gate_select}">请选择闸机:</option>
					</select>
					<div style="color: red" th:text="#{auth.msg_1}">注： 授权前，必须保证设备在线，离线的设备无法授权。</div>
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label layui-required" th:text="#{auth.staff}">选择人员:</label>
				<div class="layui-input-block">
					<input type="hidden" name="staffList" id="deptId">
					<ul id="deptTree" class="dtree" data-id="0"></ul>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label layui-required" th:text="#{auth.time_frame}">时间范围</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" name="authorTime"
						id="authorTime" value="00:00:00 - 24:00:00">
				</div>

			</div>
			<div class="layui-form-item">
				<div class="layui-input-block"
					style="text-align: center; padding-right: 7%">
					<button type="button" class="layui-btn layui-btn-radius"
						lay-submit="" lay-filter="doSubmit" id="doSubmit">
						<i class="layui-icon layui-icon-search layui-icon-normal"></i><span th:text="#{submit}">提交</span>
					</button>
					<button type="reset"
						class="layui-btn layui-btn-radius layui-btn-warm">
						<i class="layui-icon layui-icon-refresh"></i><span th:text="#{reset}">重置</span>
					</button>
				</div>
			</div>
		</form>
	</div>

	<div id="updateGateAuthorDiv"
		style="display: none; padding: 10px; padding-right: 5%">
		<form action="" method="post" class="layui-form" id="updateFrm"
			lay-filter="updateFrm">
			<div class="layui-form-item">
				<div class="layui-inline">
					<label class="layui-form-label layui-required" th:text="#{auth.gate_name}">闸机名称:</label>
					<div class="layui-input-block">
						<input type="hidden" name="id"> <input type="text"
							name="gateName" readonly="readonly" lay-verify="required"
							autocomplete="off" class="layui-input input-radius">
					</div>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label layui-required" th:text="#{auth.staff}">选择人员:</label>
				<div class="layui-input-block" id="treebox2">
					<input type="hidden" name="staffList" class="layui-input"
						id="deptId2"> <input class="layui-input" id="nameInput"
						readonly="readonly">
					<ul id="deptTree2" hidden="hidden" class="dtree" data-id="0"></ul>
				</div>
			</div>

			<div class="layui-form-item">
				<label class="layui-form-label layui-required" th:text="#{auth.time_frame}">时间范围</label>
				<div class="layui-input-inline">
					<input type="text" class="layui-input" name="authorTime"
						id="authorTime2" value="00:00:00 - 24:00:00">
				</div>

			</div>

			<div class="layui-form-item">
				<div class="layui-input-block"
					style="text-align: center; padding-right: 7%">
					<button type="button" class="layui-btn layui-btn-radius"
						lay-submit="" lay-filter="doSubmit" id="doSubmit">
						<i class="layui-icon layui-icon-search layui-icon-normal"></i><span th:text="#{submit}">提交</span>
					</button>
					<button type="reset"
						class="layui-btn layui-btn-radius layui-btn-warm">
						<i class="layui-icon layui-icon-refresh"></i><span th:text="#{reset}">重置</span>
					</button>
				</div>
			</div>
		</form>
	</div>

	<script type="text/javascript" src="/resources/layui/layui.js"></script>
	<script type="text/javascript" src="/resources/js/cache.js"></script>

	<script type="text/javascript">
		//提升数据表格的作用域，因为底下还有一个reloadTable方法
		var tableIns;
		layui.extend({
			dtree : '/resources/layui_ext/dtree/dtree'
		}).use(
				[ 'jquery', 'form', 'element', 'layer', 'table', 'upload',
						'dtree', 'laydate' ],
				function() {
					var $ = layui.jquery;
					var form = layui.form;
					var layer = layui.layer;
					var table = layui.table;
					var upload = layui.upload;
					var dtree = layui.dtree;
					var tree = layui.tree;
					var element = layui.element;
					var laydate = layui.laydate;

					laydate.render({
						elem : '#authorTime',
						type : 'time',
						range : true
					});

					laydate.render({
						elem : '#authorTime2',
						type : 'time',
						range : true
					});

					//初始化表格 加载数据
					tableIns = table.render({
						elem : "#gateAuthorTable",
						title : "闸机授权数据表格",
						url : "/gateAuthor/loadAllGateAuthor",
						toolbar : "#gateAuthorToolBar",
						page: {layout: ["prev","page","next","limit"]},
						height : "full-180",
						cols : [ [ {
							type : 'checkbox',
							width : 50
						}, {
							field : 'id',
							title : 'ID',
							align : 'center',
							width : '50'
						}, {
							field : 'gateName',
							title : '[[#{auth.gate_name}]]',
							align : 'center',
							width : '100'
						}, {
							field : 'nameList',
							title : '[[#{auth.staff}]]',
							align : 'center',
							width : '250'
						}, {
							field : 'authorTime',
							title : '[[#{auth.time_frame}]]',
							align : 'center',
							width : '180'
						}, {
							field : 'createTime',
							title : '[[#{auth.createTime}]]',
							align : 'center',
							width : '180'
						}, {
							field : 'updateTime',
							title : '[[#{auth.updateTime}]]',
							align : 'center',
							width : '180'
						}, {
							fixed : 'right',
							title : '[[#{operation}]]',
							toolbar : '#gateAuthorRowBar',
							align : 'center',
							width : '180'
						} ] ],
						done : function(data, curr, count) {
							localStorage.setItem("time", new Date().getTime())
							//不是第一页时，如果当前返回的数据为0那么就返回上一页
							if (data.data.length == 0 && curr != 1) {
								tableIns.reload({
									page : {
										curr : curr - 1
									}
								})
							}
							//当是第一页时，如果当前返回的数据为0并且当前为第一页  给一个空的查询条件，并给curr赋初值为1
							// if (data.data.length == 0 && curr == 1) {
							//     tableIns.reload({
							//         where: "",
							//         page: {
							//             curr: 1
							//         }
							//     })
							// }

						}
					});

					//监控模糊查询按钮事件
					form.on("submit(doSearch)", function(data) {
						tableIns.reload({
							where : data.field,
							page : {
								curr : 1
							}
						});
						return false;
					});

					//初始化查询条件的下拉列表
					$.get("/gate/loadAllGateForSelect", function(res) {
						var data = res.data;
						var dom = $("#select_gateId");
						var html = '<option value=" " >[[#{auth.gate_select}]]</option>';
						$.each(data, function(index, item) {
							html += '<option value="' + item.id + '">'
									+ item.gateName + '</option>';
						})
						dom.html(html);
						//重新渲染下拉列表
						form.render("select");
					});

					//初始化查询条件的下拉列表
					function getOptions() {
						$.get("/gate/loadAllGateForLeft", function(res) {
							var data = res.data;
							var dom = $("#select_left_gateId");
							var html = '<option value=" " >[[#{auth.gate_select}]]</option>';
							$.each(data, function(index, item) {
								html += '<option value="' + item.id + '">'
										+ item.gateName + '</option>';
							})
							dom.html(html);
							//重新渲染下拉列表
							form.render("select");
						});
					}

					//初始化添加弹出层所属部门的下拉列表
					var deptTree = dtree.renderSelect({
						elem : "#deptTree",
						checkbar : true,
						id : "treeParam",
						checkbarFun : {
							chooseBefore : function($i, node) { // 复选框点击前回调
								return true;
							},
							chooseDone : function(checkbarNodesParam) { //复选框点击事件完毕后，返回该树关于复选框操作的全部信息，用于用户自定义，如未指定则树只是页面上做了修改
								setView()
							}
						},
						toolbarFun : {

						},
						checkbarType : "all",
						width : "100%", // 可以在这里指定树的宽度来填满div
						dataStyle : "layuiStyle", //使用layui风格的数据格式
						dataFormat : "list", //配置data的风格为list
						response : {
							message : "msg",
							statusCode : 0
						}, //修改response中返回数据的定义
						url : "/dept/loadGateUnscheduled" // 使用url加载（可与data加载同时存在）
					});

					var hidden = 1;
					$("#nameInput").click(function() {
						console.log("nameInput click")
						if (hidden == 1) {
							$("#deptTree2").removeAttr("hidden")
							hidden = 0
						} else {
							$("#deptTree2").attr("hidden", "hidden")
							hidden = 1
						}
					})

					//监听所属部门点击方法
					dtree.on("node(deptTree)", function(obj) {
						//将该部门的id赋值给隐藏域，
						setView()
					});

					dtree.on("node(deptTree2)", function(obj) {
						//将该部门的id赋值给隐藏域，
						setView2()
					});

					function setView() {
						var permissionData = dtree
								.getCheckbarNodesParam("deptTree");
						console.log(permissionData);
						var str = ''
						var idList = ''

						$.each(permissionData, function(index, item) {
							if (item.nodeId.length > 5) {
								str += item.context + ","
								idList += (item.nodeId.substring(5)) + ","
							}

						})
						console.log(str)
						console.log(idList)
						$("#deptId").val(idList)
						$("#deptTree_select_input_id").val(str)
					}

					function setView2() {

						var permissionData = dtree
								.getCheckbarNodesParam("deptTree2");
						console.log(permissionData);
						var str = ''
						var idList = ''

						$.each(permissionData, function(index, item) {
							if (item.nodeId.length > 5) {
								str += item.context + ","
								idList += (item.nodeId.substring(5)) + ","
							}

						})
						console.log(str)
						console.log(idList)
						$("#deptId2").val(idList)
						$("#nameInput").val(str)
					}

					//监控工具条事件
					table.on("toolbar(gateAuthorTable)", function(obj) {
						//获取当前行数据
						var data = obj.data;
						switch (obj.event) {
						case 'add':
							openAddLayer();
							break;
						case 'config':
							configGateAuthor(data);
							break;
						case 'download':
							downloadTemp();
							break;
						}
						;
					});

					//监控行工具条事件
					table.on("tool(gateAuthorTable)", function(obj) {
						//获取当前行数据
						var data = obj.data;
						switch (obj.event) {
						case 'delete':
							deleteGateAuthor(data);
							break;
						case 'update':
							updateGateAuthor(data);
							break;
						}
						;
					});

					var mainIndex;
					var url;

					//打开添加弹出层
					function openAddLayer() {
						getOptions();

						mainIndex = layer.open({
							type : 1,
							content : $("#addGateAuthorDiv"),
							area : [ '700px', '500px' ],
							title : '[[#{auth.add_auth}]]',
							success : function() {
								$("#dataFrm")[0].reset();
								url = "/gateAuthor/addGateAuthor";
							}
						});
					}

					//打开修改的弹出层
					function updateGateAuthor(data) {
						console.log(data)
						mainIndex = layer.open({
							type : 1,
							content : $("#updateGateAuthorDiv"),
							area : [ '700px', '500px' ],
							title : '[[#{auth.update_auth}]]',
							success : function() {
								//清空原有的数据
								$("#updateFrm")[0].reset();
								// 装载新的数据
								dtree.render({
									elem : "#deptTree2",
									checkbar : true,
									checkbarFun : {
										chooseBefore : function($i, node) { // 复选框点击前回调
											return true;
										},
										chooseDone : function(
												checkbarNodesParam) { //复选框点击事件完毕后，返回该树关于复选框操作的全部信息，用于用户自定义，如未指定则树只是页面上做了修改
											setView2()
										}
									},
									toolbarFun : {

									},
									checkbarType : "all",
									width : "100%", // 可以在这里指定树的宽度来填满div
									dataStyle : "layuiStyle", //使用layui风格的数据格式
									dataFormat : "list", //配置data的风格为list
									response : {
										message : "msg",
										statusCode : 0
									}, //修改response中返回数据的定义
									url : "/dept/loadGateUnscheduled?authId="
											+ data.id
								});

								form.val("updateFrm", data);
								url = "/gateAuthor/updateGateAuthor";
								$("#nameInput").val(data.nameList)
							}

						});
					}
					;

					form.on("submit(doSubmit)", function(data) {
						if (data.field.gateId == " ") {
							layer.msg("[[#{auth.gate_select}]]");
							return false;
						} else {
							console.log("非空 " + data.field.gateId)
						}

						$.post(url, data.field, function(res) {
							localStorage.setItem("time", new Date().getTime())
							if (res.code == 200) {
								tableIns.reload();
							}
							layer.msg(res.msg);
							layer.close(mainIndex);
						});
						return false;
					});

					//删除
					function deleteGateAuthor(data) {
						layer.confirm('[[#{delete_confirm}]]' + data.id + '[[#{auth.this}]]', {
							btn: ['<span class=layui-icon>&#xe605;[[#{confirm}]]</span>','<span class=layui-icon>&#x1006;[[#{cancel}]]</span>']
							,
							icon : 3,
							title : '[[#{window_notice}]]'
						}, function(index) {
							$.post("/gateAuthor/deleteGateAuthor", {
								id : data.id
							}, function(res) {
								localStorage.setItem("time", new Date()
										.getTime())
								if (res.code == 200) {
									tableIns.reload();
								}
								layer.msg(res.msg);
							});
							layer.close(index);
						});
					}
					;
				});
	</script>
</body>
</html>